#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook for Zuna Simple Decor
echo "🔍 Running pre-commit checks..."

# Check for .env files
if git diff --cached --name-only | grep -E "\.env$|\.env\.local$|\.env\.production$"; then
    echo "❌ ERROR: .env files detected in commit!"
    echo "Please remove environment files from staging:"
    echo "  git reset HEAD .env"
    exit 1
fi

# Check for potential secrets in staged files
if git diff --cached | grep -E "(api_key|API_KEY|password|secret|token)" | grep -v "VITE_"; then
    echo "⚠️  WARNING: Potential secrets detected in staged files!"
    echo "Please review your changes carefully."
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for large files (>50MB)
if git diff --cached --name-only | xargs ls -la 2>/dev/null | awk '$5 > 52428800 { print $9, $5 }' | grep -q .; then
    echo "❌ ERROR: Large files detected (>50MB)!"
    echo "Consider using Git LFS for large files."
    exit 1
fi

# Run linting for specific directories
echo "🔍 Running ESLint..."

# Lint client if files changed
if git diff --cached --name-only | grep "^client/" | grep -E "\.(js|jsx|ts|tsx)$"; then
    cd client && npm run lint
    if [ $? -ne 0 ]; then
        echo "❌ Client linting failed!"
        exit 1
    fi
    cd ..
fi

# Lint admin-cms if files changed
if git diff --cached --name-only | grep "^admin-cms/" | grep -E "\.(js|jsx|ts|tsx)$"; then
    cd admin-cms && npm run lint
    if [ $? -ne 0 ]; then
        echo "❌ Admin CMS linting failed!"
        exit 1
    fi
    cd ..
fi

echo "✅ Pre-commit checks passed!"
